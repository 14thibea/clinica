# The ClinicA Processed Structure (CAPS) Specification


# Changelog
## version 0.1.0
- work in progress


# Introduction

## Motivation

Clinica uses the BIDS specification for the input (raw data). There is an ongoing initiative called BIDS-derivatives that aim to provide a BIDS standard for processed data (see [BIDS Derivatives Specification](https://docs.google.com/document/d/1Wwc4A6Mow4ZPPszDIWfCUCRNstn7d_zzaWPcfcHmgI4/edit#heading=h.mqkmyp254xh6)). However, this specification is not yet mature and, in its current state, many outputs needed by Clinica are not covered. This is why Clinica has its own specifications called CAPS. CAPS (designed by [AramisLab](http://www.aramislab.fr/)) defines a hierarchy for the Clinica processed data. The idea is to include in one folder all the results of the several pipelines and organize the data following the main patterns of the BIDS specification. Moreover, it aims to be as close as possible of the BIDS guidelines. CAPS folders  should be kept separate from the raw data. Indeed, when processing routinely raw datasets, it is very common to have the raw data located at slow data storage or read-only storage and ongoing processed data are located on faster data storage.


## Definitions

We use the same definitions of BIDS Specifications 1.0.0 concerning **Dataset**, ** Subject**, **Session**, **MRI acquisition**, **Data type**, **Task**, **Event** and **Run**. On top on that, we define the notion of:

1. **Group** - a set of subjects. There is one flag that you will meet when working on any group-wise analysis (e.g. template creation from a list of subjects, statistical analysis). This is simply a label name that will define the group of subjects used for this analysis. It will be written in your output CAPS folder, for possible future reuses. For example, an `AD` group_id label could be used in case you create a template for a group of Alzheimer’s disease patients. Any time you would like to use this `AD` template you will need to provide the group_id used to identify the pipeline output obtained from this group. You might also use `CNvsAD`, for instance, as group_id for a statistical group comparison.


## Differences with BIDS

As explained on the Motivation section, the `derivatives/` folder is not taken into account. It replaced by the CAPS folder.

CAPS assumes that the session is always present in a BIDS dataset even though there is a single session. In other words, all datasets are considered longitudinal, even when they have only one session.

One last difference with BIDS specifications is that NifTi files generated by a pipeline are always compressed.


# Subject and group naming

The naming convention for subjects (participants) is identical to the BIDS Specifications 1.0.0.

Groups should be assigned unique labels. Labels can consist of letters and/or numbers.



# Directory structure (single session example)

```
subjects/
└── sub-CLNC01/
    └── ses-M00/
        └── dwi/
            ├── dti_based_processing/
            │   ├── atlas_statistics/
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-JHUTracts0_res-1x1x1_map-FA_statistics.tsv
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-JHUTracts0_res-1x1x1_map-MD_statistics.tsv
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-JHUTracts0_res-1x1x1_map-AD_statistics.tsv
            │   │   └── sub-CNLC01_ses-M00_acq-axial_dwi_space-JHUTracts0_res-1x1x1_map-RD_statistics.tsv
            │   ├── native_space/
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_model-DTI_diffmodel.nii.gz
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_FA.nii.gz
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_MD.nii.gz
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_AD.nii.gz
            │   │   ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_RD.nii.gz
            │   │   └── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_DECFA.nii.gz
            │   └── normalized_space/
            │       ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_AD.nii.gz
            │       ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_affine.mat
            │       ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_deformation.nii.gz
            │       ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_FA.nii.gz
            │       ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_MD.nii.gz
            │       └── sub-CNLC01_ses-M00_acq-axial_dwi_space-MNI152Lin_res-1x1x1_RD.nii.gz
            └── preprocessing/
                ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_brainmask.nii.gz
                ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_preproc.bval
                ├── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_preproc.bvec
                └── sub-CNLC01_ses-M00_acq-axial_dwi_space-b0_preproc.nii.gz
```

# Directory structure (group example)

This CAPS folder contains the outputs of a group comparison of patients with Alzheimer’s disease (`AD`) and healthy subjects (`Control`) thanks to the `statistics-surface` pipeline. Results are stored under the group ID `ADvsHC`:

```
groups/
└── group-ADvsHC/
    └── statistics/
        ├── participant.tsv
        └── surfstat_group_comparison/
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_FDR.jpg
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_FDR.mat
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_TStatistics.jpg
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_TStatistics.mat
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_correctedPValue.jpg
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_correctedPValue.mat
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_uncorrectedPValue.jpg
            ├── group-ADvsHC_Control-lt-AD_measure-ct_fwhm-20_uncorrectedPValue.mat
            ├── group-ADvsHC_glm.json
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_FDR.jpg
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_FDR.mat
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_TStatistics.jpg
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_TStatistics.mat
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_correctedPValue.jpg
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_correctedPValue.mat
            ├── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_uncorrectedPValue.jpg
            └── group-ADvsHC_AD-lt-Control_measure-ct_fwhm-20_uncorrectedPValue.mat
```

# Detailed file descriptions

##  T1 MRI data

### `t1-volume` pipeline - Processing of T1w MR images using SPM

#### Segmentation
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── spm/
                └── segmentation/
                    ├── normalized_space/
                    │   ├── <source_file>_target-Ixi549Space_transformation-{inverse|forward}_deformation.nii.gz
                    │   ├── <source_file>_segm-<segm>_space-Ixi549Space_modulated-{on|off}_probability.nii.gz
                    │   └── <source_file>_space-Ixi549Space_T1w.nii.gz
                    ├── native_space/
                    │   └── <source_file>_segm-<segm>_probability.nii.gz
                    └── dartel_input/
                        └── <source_file>_segm-<segm>_dartelinput.nii.gz
```

The `modulated-{on|off}` key indicates if modulation has been used in SPM to compensate for the effect of spatial normalization.

The possible values for the `segm-<segm>` key/value are: `graymatter`, `whitematter`, `csf`, `bone`, `softtissue`, and `background`.

The T1 image in `Ixi549Space` (reference space of the TPM) is obtained by applying the transformation obtained from the SPM Segmentation routine to the T1 image in native space.


#### DARTEL
Template:
```
groups/
└── group-<group_label>/
    ├── group-<group_label>_subjects_visits_list.tsv
    └── t1/
        ├── group-<group_label>_iteration-<index>_template.nii.gz
        └── group-<group_label>_template.nii.gz
```

The final group template is `group-<group_label>_template.nii.gz`.

The `group-<group_label>_iteration-<index>_template.nii.gz` obtained at each iteration will only be used when obtaining flow fields for registering a new image into an existing template (SPM DARTEL Existing templates procedure). Note for SPM experts: the original name is `Template<index>.nii`.


#### DARTEL to MNI
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── spm/
                └── dartel/
                    └── group-<group_label>/
                        ├── <source_file>_target-<group_label>_transformation-forward_deformation.nii.gz
                        └── <source_file>_segm-<segm>_space-Ixi549Space_modulated-[on|off][_fwhm-<X>mm]_probability.nii.gz
```

#### Atlas statistics
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── spm/
                └── dartel/
                    └── group-<group_label>/
                        └── atlas_statistics/
                            └── <source_file>_space-<space>_map-graymatter_statistics.tsv
```

Statistics files (with `_statistics.tsv` suffix) are detailed in appendix 2.


### `t1-freesurfer` - Processing of T1w MR images using FreeSurfer
There are two parts: 1) a simple copy of the FreeSurfer output; 2) additions which are specific to CAPS.

The first part (copy of the FreeSurfer output) is as follows:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── freesurfer_cross_sectional/
                └── sub-<participant_label>_ses-<session_label>/
                    ├── label/
                    ├── mri/
                    ├── scripts/
                    ├── stats/
                    └── surf/
```

The second part (pipeline-specific additions) is as follows:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── freesurfer_cross_sectional/
                └── regional_measures/
                    ├── <source_file>_parcellation-wm_volume.tsv
                    ├── <source_file>_segmentationVolumes.tsv
                    └── <source_file>_hemi-{left|right}_parcellation-<parcellation>_thickness.tsv
```

For the file: `*_hemi-{left|right}_parcellation-<parcellation>_thickness.tsv`, `_thickness` is just an example for the cortical thickness, we also have other measurements defined in the table below:


| Name                    | Suffix       | Description |
|------------------------------------------------------|
| Cortical thickness      | `_thickness` | Cortical thickness between pial surface and white surface
| Cortical volume         | `_volume`    | Volume of gray matter
| Cortical surface area   | `_area`      | Cortical surface area
| Cortical mean curvature | `_meancurv`  | Mean curvature of cortical surface


The `hemi-{left|right}` key/value stands for `left` or `right` hemisphere.

The possible values for the `parcellation-<parcellation>` key/value are: `desikan` (Desikan-Killiany Atlas), `destrieux` (Destrieux Atlas) and `ba` (Brodmann Area Maps). The TSV files for Brodmann Area contain a selection of regions, see this link for the content of this selection: [http://ftp.nmr.mgh.harvard.edu/fswiki/BrodmannAreaMaps](http://ftp.nmr.mgh.harvard.edu/fswiki/BrodmannAreaMaps)).

The details of the white matter parcellation of FreeSurfer can be found here: [https://surfer.nmr.mgh.harvard.edu/pub/articles/salat_2008.pdf](https://surfer.nmr.mgh.harvard.edu/pub/articles/salat_2008.pdf)


#### Example
Content of `sub-CLNC01_ses­-M00_T1w_segmentationVolumes.tsv`:
```
Measure:volume	Left-Lateral-Ventricle	Left-Inf-Lat-Vent	...
/path/to/freesurfer/segmentation/	12345.6	12.334	…
```

This file contains the estimation of the volumes of the different subcortical structures after segmentation.

Content of `sub-CLNC01_ses­-M00_T1w_parcellation-wm_volume.tsv`:
```
Measure:volume	wm-lh-bankssts	wm-lh-caudalanteriorcingulate ...
/path/to/freesurfer/wm parcellation/ 2474.6	1863.7 ...
```
This file contains all the white matter parcellation information.


Content of `sub-CLNC01_ses­-M00_hemi-left_parcellation-desikan_thickness.tsv`:
```
lh.aparc.thickness	lh_bankssts_thickness	lh_caudalanteriorcingulate_thickness …
/path/to/freesurfer/cortical thickness/parcellation 2.048 2.892 …
```
This file contains all the cortical thickness information based on the Desikan atlas from FreeSurfer.


### `t1-freesurfer-longitudinal` – FreeSurfer-based longitudinal processing of T1-weighted MR images
There are three parts: 1) a simple copy of the FreeSurfer unbiased template; 2) a simple copy of the FreeSurfer longitudinal output; 3) additions which are specific to CAPS.

The first part is a copy of the FreeSurfer unbiased template is as follows:
```
subjects/
└── sub-<participant_label>/
    └── long-<long_label>/
        └── freesurfer_unbiased_template/
            └── sub-<participant_label>/
                ├── label/
                ├── mri/
                ├── scripts/
                ├── stats/
                └── surf/
```

The second part is a copy of the FreeSurfer longitudinal output:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── long-<long_label>/
                └── freesurfer_longitudinal/
                    └── sub-<participant_label>_ses-<session_label>.long.sub-<participant_label>/
                        ├── label/
                        ├── mri/
                        ├── scripts/
                        ├── stats/
                        └── surf/
```

The last part (pipeline-specific additions) is as follows:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── t1/
            └── long-<long_label>/
                └── freesurfer_longitudinal/
                    └── regional_measures/
                        ├── <source_file>_parcellation-wm_volume.tsv
                        ├── <source_file>_segmentationVolumes.tsv
                        └── <source_file>_hemi-{left|right}_parcellation-<parcellation>_thickness.tsv
```
where each file is explained in `t1-freesurfer` sub-section.

#### Notes
The naming convention `<subject_name>.long.<template_name>` is imposed by FreeSurfer.


## Diffusion imaging data
### `dwi-preprocessing-*` - DWI pre-processing
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── dwi/
            └── preprocessing/
                ├── <source_file>_space-<space>_preproc.nii.gz
                ├── <source_file>_space-<space>_preproc.bval
                ├── <source_file>_space-<space>_preproc.bvec
                └── <source_file>_space-<space>_brainmask.nii.gz
```

The resulting DWI file after preprocessing. According to the subtype of pipeline run, space can be `T1w` (`dwi-preprocessing-using-t1` pipeline) or `b0` (`dwi-preprocessing-using-fieldmap` pipeline). A brain mask of the preprocessed file is provided.


### `dwi-dti` - DTI scalar maps (FA, MD, AD, RD) and spatial normalization
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses­-<session_label>/
        └── dwi/
            └── dti_based_processing/
                ├── native_space/
                │   ├── <source_file>_space-<space>_model-DTI_diffmodel.nii.gz
                │   ├── <source_file>_space-<space>_{FA|MD|AD|RD}.nii.gz
                │   └── <source_file>_space-<space>_DECFA.nii.gz
                │── normalized_space/
                │   ├── <source_file>_space-MNI152Lin_res-1x1x1_affine.mat
                │   ├── <source_file>_space-MNI152Lin_res-1x1x1_deformation.nii.gz
                │   └── <source_file>_space-MNI152Lin_res-1x1x1_{FA|MD|AD|RD}.nii.gz
                └── atlas_statistics/
                    └── <source_file>_space-<space>_res-1x1x1_map-{FA|MD|AD|RD}_statistics.tsv
```

The DTI is saved the `*_model-DTI_diffmodel.nii.gz` filename. The different maps based on the DTI are the fractional anisotropy (`FA`), mean diffusivity (`MD`), axial diffusivity (`AD`) and radial diffusivity (`RD`) and directionally-encoded colour (DEC) FA (`DECFA`) map.

Current atlases used for statistics are the 1mm version of JHUDTI81, JHUTract0 and JHUTract25 (see appendix 1 for details on these atlases).

Statistics files (with `_statistics.tsv` suffix) are detailed in appendix 2.


##### Notes
The naming convention for suffixes follows the BIDS derivative specifications except for the statistics files (specific files for our needs) and the `_deformation.nii.gz` file (it is equivalent to the `_warp.nii.gz` file in the BEP014 specifications).


## Functional MRI data
### `fmri-preprocessing` - fMRI pre-processing
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── fmri/
            └── preprocessing/
                ├── <source_T1w>_brainmask.nii.gz
                ├── <source_bold>_motion.tsv
                ├── <source_bold>_space-Ixi549Space_fwhm-8x8x8_preproc.nii.gz
                ├── <source_bold>_space-Ixi549Space_preproc.nii.gz
                ├── <source_bold>_space-meanBOLD_preproc.nii.gz
                └── <source_bold>_space-T1w_preproc.nii.gz
```

The `<source_bold>_motion.tsv` corresponds to the translations (`TransX`, `TransY`, and `TransZ`) in mm and the rotations (`RotX`, `RotY`, and `RotZ`) in  of each volume as compared to the first one, generated by the Realign tool of **SPM**. Thus, the size of the array should be `Mx6`, `M` being the number of volumes in the original fMRI file.

!!! note
The naming convention for suffixes tried to follow the [BIDS Extension Proposal 12 (BEP012): BOLD processing derivatives](https://docs.google.com/document/d/16CvBwVMAs0IMhdoKmlmcm3W8254dQmNARo-7HhE-lJU/edit#) as much as possible.


## PET imaging data

### `pet-volume` - Volume-based processing of PET images
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── pet/
            └── preprocessing/
                └── group-<group_label>/
                    ├── <source_file>_space-T1w_pet.nii.gz
                    ├── <source_file>_space-T1w[_pvc-rbv]_pet.nii.gz
                    ├── <source_file>_space-Ixi549Space[_pvc-rbv]_pet.nii.gz
                    ├── <source_file>_space-Ixi549Space[_pvc-rbv]_suvr-<suvr>_pet.nii.gz
                    ├── <source_file>_space-Ixi549Space_brainmask.nii.gz
                    └── <source_file>_space-Ixi549Space[_pvc-rbv]_suvr-<suvr>_mask-brain_pet.nii.gz
```
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── pet/
            └── preprocessing/
                └── atlas_statistics/
                    └── <source_file>_space-<space>[_pvc-rbv]_suvr-<suvr>_statistics.tsv
```

`[_pvc-rbv]` label is optional depending on whether your image has undergone Partial Value Correction (region-based voxel-wise method) or not.

The possible values for the `suvr-<suvr>` key/value are: `pons` for FDG-PET and `cerebellumPons` for different types of amyloid PET.

Statistics files (with `_statistics.tsv` suffix) are detailed in appendix 2.


### `pet-surface` - Surface-based processing of PET images
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── pet/
            └── surface/
                ├── atlas_statistics/
                │   └── <source_file>_task-<label>_acq-<label>_pet_space-<space>_pvc-iy_suvr-<suvr>_statistics.tsv
                ├── <source_file>_hemi-{left|right}_midcorticalsurface
                └── <source_file>_hemi-{left|right}_task-rest_acq-<label>_pet_space-<space>_suvr-<suvr>_pvc-iy_hemi-{left|right}_fwhm-<label>_projection.mgh
```

The possible values for the `suvr-<suvr>` key/value are: `pons` for FDG-PET and `cerebellumPons `for different types of amyloid PET. The only label for the `_pvc-<label>_` is `iy`, short for Iterative Yang, which describes the partial volume correction used in the algorithm for the projection. The `_acq-<label>` key/value describes the radiotracer used in the PET acquisition (now supported: `fdg` and `av45`)

The `fwhm` represents the FWHM (in mm) of the Gaussian filter applied to the data mapped onto the FsAverage surface. The different values are 0 (no smoothing), 5, 10, 15, 20, and 25.

Files with `_midcorticalsurface` suffix represent the surface at equal distance between the white matter/gray matter interface and the pial surface (One per hemisphere).

Files with `projection` suffix are PET data that can be mapped onto meshes. If `_space_fsaverage_` is in the name, it can be mapped either onto the white or pial surface of FsAverage. If `_space_native_` is in the name, it can be mapped onto the white or pial surface of the subject’s surface (`{l|r}h.white`, `{l|r}h.pial` files from `t1-freesurfer` pipeline).

Files with `statistics` suffix are text files that display average PET values on either `_space-desikan` or `_space-destrieux` atlases. Example of this content can be found in appendix 2.


## Statistics

### `statistics-surface` - Surface-based mass-univariate analysis with SurfStat

#### Group comparison
Template:
```
groups/
└── group-<group_label>/
    └── statistics/
        ├── participants.tsv
        └── surfstat_group_comparison/
            ├── group-<group_label>_<group_1>-lt-<group_2>_measure-<measure>_fwhm-<label>_correctedPValue.jpg
            ├── group-<group_label>_<group_2>-lt-<group_1>_measure-<measure>_fwhm-<label>_correctedPValue.jpg
            ├── group-<group_label>_<group_1>-lt-<group_2>_measure-<measure>_fwhm-<label>_correctedPValue.mat
            ├── group-<group_label>_<group_2>-lt-<group_1>_measure-<measure>_fwhm-<label>_correctedPValue.mat
            ├── group-<group_label>_participants.tsv
            ├── group-<group_label>_output.log
            └── group-<group_label>_glm.json
```


In the case above, `_correctedPValue` indicates that these are maps of corrected p-values. Other types of maps include, but are not limited to:


| Name                | Suffix               | Description |
|--------------------------------------------|
| Corrected p-value   | `_correctedPValue`   | Corrected P-values for vertices and clusters level based on random field theory
| Uncorrected p-value | `_uncorrectedPValue` | Uncorrected P-value for a  generalized linear model
| T-statistics        | `_TStatistics`       | T statistics for a generalized linear model
| FDR                 | `_FDR`               | Q-values for False Discovery Rate of resels



The `<group_1>-lt-<group_2>` means the tested hypothesis is: the measurement of `<group_1>` is lower than (`lt`) that `<group_2>`.

The value for `measure` is `ct `which corresponds to cortical thickness (currently, this is the only measure proposed by Clinica), and the value for `fwhm` corresponds to the size of the surface-based smoothing in mm and can be `5`, `10`, `15`, `20`.

The JPEG files are simple snapshots. The `*.mat` files can be read later by tools like PySurfer and Surfstat.


##### Example

```
groups/
└── group-ADvsHC/
    └── statistics/
        ├── participants.tsv
        └── surfstat_group_comparison/
            ├── group-ADvsHC_AD-lt-HC_measure-ct_fwhm-20_correctedPValue.jpg
            ├── group-ADvsHC_participants.tsv
            ├── group-ADvsHC_output.log
            └── group-ADvsHC_glm.json
```

Group comparison between patients with Alzheimer’s Disease (`group_1` = `AD`) and healthy subjects (`group_2` = `HC`). `ADvsHC` defines the `group_label`.

The `group-ADvsHC_glm.json` contains the information for your generalized linear model, for example:

```
{
    "DesignMatrix": "1 + age + sex + group"
    "StringFormatTSV": "%s %f %f"
    "Contrast": "group"
    "ClusterThreshold": 0.001
}
```


This file describes the model that you want to create, you should include the factor and covariates in your generalized linear model as a column name in this TSV file. For example, the linear model formula is: `CorticalThickness = 1 + age + sex + group`, the contrasts (factors) `group`, `age` and `sex` are the covariates. All additional information is included in the log file.

The content of `group-ADvsHC_participants.tsv` is:
```
participant_id   session_id   sex      group   age
sub-CLNC0001     ses-M00      Female   CN      71.1
sub-CLNC0002     ses-M00      Male     CN      81.3
sub-CLNC0003     ses-M00      Male     CN      75.4
sub-CLNC0004     ses-M00      Female   CN      73.9
sub-CLNC0005     ses-M00      Female   AD      64.1
sub-CLNC0006     ses-M00      Male     AD      80.1
sub-CLNC0007     ses-M00      Male     AD      78.3
sub-CLNC0008     ses-M00      Female   AD      73.2
```

(Note that to make the display clearer, the rows contain successive tabs, which should not happen in an actual TSV file.)

This file describes the model that you want to create, you should include the factor and covariates in your generalized linear model as a column name in this TSV file. For example, the linear model formula is: `CorticalThickness = 1 + age + sex + group`, the contrasts (factors) `group`, `age` and `sex` are the covariates. All additional information is included in the log file.

The `group-<group_label>` key/value stands for the `group_label` for your analysis, this is really helpful when you run different analyses for different subjects, or when you run different analyses for same subjects.

The example image here maps statistically significant differences in cortical thickness between a group of patients with Alzheimer’s disease and a group of healthy controls (yellow: correction at the vertex level; blue: correction at the cluster level).

![](img/StatsSurfStat_images/ContrastNegative-CorrectedPValue.jpg)


### Correlation analysis
Template
```
groups/
└── group-<group_label>/
    └── statistics/
        ├── participants.tsv
        └── surfstat_correlation_analysis/
            ├── group-<group_label>_correlation-<label>_contrast-{negative|positive}_measure-<measure>_fwhm-<label>_correctedPValue.jpg
            ├── group-<group_label>_correlation-<label>_contrast-{negative|positive}_measure-<measure>_fwhm-<label>_correctedPValue.mat
            ├── group-<group_label>_output.log
            ├── group-<group_label>_participants.tsv
            └── group-<group_label>_glm.json
```

The `correlation-<label>` here describes the factor of the model which can be, for example, `age`. The `contrast-{negative|positive}` is the sign of the correlation you want to study which can be `negative` or `positive`.

All other key/value pairs are defined in the same way with the section 9.5.1 for Group comparison.


<!--### Generalised Linear Model (GLM)
```
groups/
└── group-<group_label>/
    └── statistics/
        └── participants.tsv
            ├── surfstat_glm/
            └── group-<group_label>_measure-<measure>_fwhm-<label>_correctedPValue.jpeg
                ├── group-<group_label>_measure-<measure>_fwhm-<label>_correctedPValue.mat
                ├── group-<group_label>_output.log
                ├── group-<group_label>_participants.tsv
                └── group-<group_label>_glm.json
```

This section includes all the other situation for the generalized linear model. It follows the same spirit as the sections above.
-->

## Machine Learning
### `machinelearning-prepare-spatial-svm` - Prepare input data for spatially regularized SVM
Template:
```
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── machine_learning/
            └── input_spatial_svm/
                └── group-<group_label>/
                    ├── <source_file_t1w>_segm-{graymatter|whitematter|csf}_space-Ixi549Space_modulated-on_spatialregularization.nii.gz
                    └── <source_file_pet>_space-Ixi549Space[_pvc-rbv]_suvr-<suvr>_spatialregularization.nii.gz
```
```
groups/
└── group-<group_label>/
    └── machine_learning/
        └── input_spatial_svm/
            ├── group-<group_label>_space-Ixi549Space_gram.npy
            └── group-<group_label>_space-Ixi549Space_parameters.json
```


At the subject level, it contains SVM regularization of gray matter/white matter/CSF maps or PET data that accounts for the spatial and anatomical structure of neuroimaging data.

At the group level, it contains the Gram matrix with respect to gray matter/white matter/CSF maps needed for the SVM regularization and the information regarding the regularization. An example of JSON file is:


```javascript
{
    "MaxDeltaT": "0.0025",
    "Alpha": "0.0025", // Alpha such that: delta_t = MaxDeltaT * Alpha
    "Epsilon": "10E-6",
    "BoundaryConditions": "TimeInvariant",
    "SigmaLoc": "10",
    "TimeStepMax": "0.07760115580830161",
    "SpatialPrior": "Tissues (GM,WM,CSF)",
    "RegularizationType": "Fisher",
    "FWHM": "4",
}
```


# Appendix 1. List of ROI atlases in Clinica

This appendix extends the table targets/spaces table defined in the [WIP BIDS Derivatives specifications](https://docs.google.com/document/d/1Wwc4A6Mow4ZPPszDIWfCUCRNstn7d_zzaWPcfcHmgI4/edit#heading=h.4xwnp2872y57) by proposing a table of ROI atlases. Atlases used in Clinica are summarized in the table below.

| Label name         | Description |
|----------------------------------|
| JHUDTI81           | Also known as ICBM-DTI-81 white-matter labels atlas. 48 white matter tract labels were created by hand segmentation of a standard-space average of diffusion MRI tensor maps from 81 subjects; mean age 39 (18:59), M:42, F: 39. <p><p> See [Hua et al., 2008; Wakana et al., 2007] and http://www.loni.usc.edu/ICBM/Downloads/Downloads_DTI-81.shtml for details.
| JHUTracts0 <p> JHUTracts25 <p> JHUTracts50 | Also known as JHU white-matter tractography atlas. 20 structures were identified probabilistically by averaging the results of running deterministic tractography on 28 normal subjects (mean age 29, M:17, F:11). <p><p> See [Mori et al., 2005] and https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Atlases for details.
| AAL2               | Updated version of Automated Anatomical Labeling [Tzourio-Mazoyer, 2002]) where 120 regions are extracted using a macroscopic anatomical parcellation of the MNI MRI single-subject brain. <p><p> See http://www.fz-juelich.de/inm/inm-1/DE/Forschung/_docs/SPMAnatomyToolbox/SPMAnatomyToolbox_node.html for details.
| Neuromorphometrics | Maximum probability tissue labels derived from the "MICCAI 2012 Grand Challenge and Workshop on Multi-Atlas Labeling" containing 140 cortical and subcortical regions in MNI space. <p><p> See http://www.neuromorphometrics.com/ for details.
| AICHA | Atlas of Intrinsic Connectivity of Homotopic Areas, a functional brain ROIs atlas based on resting-state fMRI data acquired in 281 individuals containing 384 regions of the whole brain in MNI space.  <p><p> See http://www.gin.cnrs.fr/AICHA-344?lang=en for details.
| LPBA40 | Atlas produced from a set of whole-head MRI of 40 human volunteers. Each MRI was manually delineated to identify a set of 56 cortical and subcortical regions in MNI space.  <p><p> See [Shattuck, 2008] for details.
| Hammers | Adult brain probability maximum map based on 69 manually delineated regions drawn on MR images of 30 healthy adult subjects. <p><p> See [Hammers, 2003; Gousias, 2008] and http://brain-development.org/brain-atlases/ for details.


Table ROI atlases


# Appendix 2. Content of a statistic file

Template:
```
<source_file>_space-<space>_map-<map>_statistics.tsv
```

Statistic file on the given space (see Table targets/spaces on **Appendix 1**). The TSV file summarizes a given mean map on the different regions of the atlas. With the help of pandas (Python library), it can be easily parsed for machine learning purposes.

Possible values for `_map-<map>` key/value are:
  - For T1: `graymatter` (Gray Matter), `whitematter` (White Matter),  `csf` (CSF) and  `ct` (Cortical Thickness)
  - For DWI: `FA` (Fractional Anisotropy), `MD` (Mean Diffusivity also called Apparent Diffusion Coefficient), `AD` (Axial Diffusivity), `RD` (Radial Diffusivity), `NDI` (Neurite Density Index), `ODI` (Orientation Dispersion Index) and `FWF` (Free Water Fraction).
  - For PET: `fdg` (fluorodeoxyglucose), `av45`.

Example - Content of `sub-CLNC01_ses-M00_T1w_space-Hammers_map-graymatter_statistics.tsv`:
```
index   label_name          mean_scalar
0.0     Background          0.0011357992189
1.0     Left Hippocampus    0.576250553131
2.0     Right Hippocampus   0.681780695915
3.0     Left Amygdala       0.577247679234
...
```


(Note that to make the display clearer, the rows contain successive tabs, which should not happen in an actual TSV file.)
