# `deeplearning-prepare-data` - Prepare input data for deep learning with PyTorch

This pipeline allows the preparation of image data generated by Clinica to PyTorch tensors [[Paszke et al., 2019]](https://papers.nips.cc/paper/9015-pytorch-an-imperative-style-high-performance-deep-learning-library). In particular, three different preparations of data are proposed: complete 3D image, 3D volumetric patches or 2D slices from the image.

Currently, only outputs from [`t1-linear` pipeline](../T1_Linear) are taken into account. This pipeline was designed as a prerequisite for the deep learning classification algorithms presented in [[Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)] and showcased in [AD-DL framework](https://github.com/aramis-lab/AD-DL). Other used can be considered.

## Prerequisites
<!-- Depending on the type of feature or the type of modality you want to use, you will need to execute either the [`t1-linear` pipeline](../T1_Linear) , the [`t1-volume` pipeline](../T1_Volume) and/or the [`pet-volume` pipeline](../PET_Volume)  prior to running this pipeline. -->

You need to have performed the [`t1-linear` pipeline](../T1_Linear) on your T1-weighted MRI.

## Dependencies
If you installed the core of Clinica, this pipeline needs no further dependencies.

## Running the pipeline (command line)
The pipeline can be run with the following command line:
```Text
clinica run deeplearning-prepare-data <caps_directory> <extraction_method>
```
where:

- `caps_directory` is the folder containing the results of the [`t1-linear` pipeline](../T1_Linear) and the output of the present command, both in a [CAPS hierarchy](../../CAPS/Introduction).
- `extraction_method` is the format of the extracted features. You can choose between `image` to convert to PyTorch tensor the complete 3D image, `patch` to extract 3D volumetric patches and `slice` to extract 2D slices from the image.

By default the features are extracted from the cropped image. You can deactivate this behaviour with the `--use_uncropped_image` flag.

Pipeline options if you use `patch` extraction:

- `--patch_size`: patch size. Default value is `50`.
- `--stride_size`:  stride size. Default value is `50`.

Pipeline options if you use `slice` extraction:

- `--slice_direction`: Slice direction. You can choose between `0` (Sagittal plane), `1`(Coronal plane) or `2` (Axial plane). Default value is `0` i.e. sagittal plane.
- `--slice_mode`: Slice mode. You can choose between `rgb` (will save the slice in three identical channels) or ‘single’ (will save the slice in a single channel). Default value is `rgb`.

!!! note "Regarding the default values"
	When using patch or slice extraction, default values were set according to [[Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)].

!!! note
	The arguments common to all Clinica pipelines are described in [Interacting with clinica](../InteractingWithClinica).

!!! tip
	Do not hesitate to type `clinica run deeplearning-prepare-data --help` to see the full list of parameters.


## Outputs
In the the following subsections, files with `.pt` extension denote tensors in PyTorch format.

The full list of output files can be found in the [ClinicA Processed Structure (CAPS) Specification](../../CAPS/Specifications/#deeplearning-prepare-data-prepare-input-data-for-deep-learning-with-pytorch).
### Image-based outputs

Results are stored in the following folder of the [CAPS hierarchy](docs/CAPS): `subjects/<subject_id>/<session_id>/deeplearning_prepare_data/image_based/t1_linear`.

The main output files are:
- `<source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_T1w.pt`: T1w image registered to the [`MNI152NLin2009cSym` template](https://bids-specification.readthedocs.io/en/stable/99-appendices/08-coordinate-systems.html) and optionally cropped.

### Patch-based outputs

Results are stored in the following folder of the [CAPS hierarchy](docs/CAPS): `subjects/sub-<participant_label>/ses-<session_label>/deeplearning_prepare_data/patch_based/`.

The main output files are:
...

### Slice-based outputs

Results are stored in the following folder of the [CAPS hierarchy](docs/CAPS): `subjects/sub-<participant_label>/ses-<session_label>/deeplearning_prepare_data/slice_based/`.

The main output files are:
...




## Describing this pipeline in your paper

!!! cite "Example of paragraph"
These results have been obtained using the `deeplearning-prepare-data` pipeline of Clinica [[Routier et al](https://hal.inria.fr/hal-02308126/); [Wen et al., 2020](https://doi.org/10.1016/j.media.2020.101694)]. More precisely, _____



!!! tip
   Easily access the papers cited on this page on [Zotero](https://www.zotero.org/groups/2240070/clinica_aramislab/collections/8B2R2826).




# CAPS Specifications
## Template
```text
subjects/<subject_id>/<session_id>/
    deeplearning_prepare_data/
        image_based/
            <pipeline_name>
                <source_file>_key1-<value_1>...keyN-<value_N>_suffix.pt
            t1_linear/
                <source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_T1w.pt
            pet_linear/ # e.g. Master project of Ravi
            t1_volume/  # Likely extension of dl-prepare-data
            bids/       # Not in AD-DL but could be
                <source_file>.pt
        patch_based/
            <pipeline_name>
                <source_file>_key1-<value_1>...keyN-<value_N>_patchsize-<N>_stride-<M>_patch-<index>_suffix.pt
            t1_linear/
                <source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_patchsize-<N>_stride-<M>_patch-<i>_T1w.pt
        slice_based/
            <pipeline_name>
            <source_file>_key1-<value_1>...keyN-<value_N>_axis-{sag|cor|axi}_channel-{single|rgb}_slice-<i>_suffix.pt
            t1_linear/
<source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_axis-{sag|cor|axi}_channel-{single|rgb}_slice-<i>_T1w.pt
        roi_based/    # Maybe one day (user should be able to give the coordinates or a mask)
```

### Image extraction
Since `deep-learning-prepare-data` can be generalized to any data produced by Clinica, results are stored in a subfolder `<pipeline_name>` where `<pipeline_name>` is the name of the command line and `-` are replaced by `_`.


For `t1-linear`, we have:
```Text
subjects/
└── sub-<participant_label>/
    └── ses-<session_label>/
        └── deeplearning_prepare_data
            └── image_based/
                └── t1_linear/
                    └── <source_file>_space-MNI152NLin2009cSym[_desc-Crop]_res-1x1x1_T1w.pt
```
### Patch extraction

cf Whole image + explanation of _patchsize-<N>_stride_<M>_patch-<index>

### Slice extraction

cf Whole image + explanation of _axis-{sag|cor|axi}_channel-{1|3}_slice-<index>

### Note
In first versions of CAPS, outputs were sorted by modality then a meaningful folder name (and optional subfolder if needed). With some hindsights, if the CLI of a pipeline is called modality-my-pipeline, outputs should be stored in subjects/<subject_id>/<session_id>/modality_my_pipeline
It decreases a little bit the number of sub-folders while having outputs sorted by modality
It is closer to BIDS-Derivatives recommandations
Drawback: it breaks the previous CAPS convention (i.e.subjects/<subject_id>/<session_id>/modality/my_pipeline).
However, first pipelines (e.g. t1-volume) do not follow this convention either (i.e. subjects/<subject_id>/<session_id>/t1/spm instead of  subjects/<subject_id>/<session_id>/t1/volume).
